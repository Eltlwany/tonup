<!doctype html>
<html lang="ar">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1, user-scalable=no">
<title>TONHUB - Full Merged (ready)</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
<style>
  :root{--font-family:'Poppins',sans-serif;--primary-color:#0088cc;--secondary-color:#36aeea;--background-dark:#17212b;--surface-dark:#1c2a38;--text-primary-dark:#e9eef3;}
  *{box-sizing:border-box}body{font-family:var(--font-family);margin:0;background:var(--background-dark);color:var(--text-primary-dark);-webkit-font-smoothing:antialiased}
  #app-loader{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:#0f1922;color:#fff;z-index:9999;flex-direction:column}
  #app{max-width:500px;margin:0 auto;padding:16px;display:none}
  .spinner{width:48px;height:48px;border-radius:50%;border:5px solid rgba(255,255,255,0.08);border-top-color:var(--primary-color);animation:spin 1s linear infinite;margin-bottom:12px}
  @keyframes spin{to{transform:rotate(360deg)}}
  .banner{position:fixed;top:16px;left:0;right:0;display:flex;justify-content:center;pointer-events:none;z-index:10000}
  .banner-inner{pointer-events:auto;padding:12px 16px;border-radius:14px;background:#0f1720;color:#fff;display:flex;align-items:center;gap:10px;box-shadow:0 8px 30px rgba(0,0,0,0.6)}
  .task-container{background:var(--surface-dark);padding:14px;border-radius:12px;margin:12px 0;border:1px solid rgba(255,255,255,0.03)}
  .action-btn{background:linear-gradient(90deg,var(--primary-color),var(--secondary-color));color:#fff;border:0;padding:10px 14px;border-radius:10px;cursor:pointer}
  .profile-header{display:flex;flex-direction:column;align-items:center;text-align:center;padding:20px 10px;border-radius:12px}
  #user-photo{width:80px;height:80px;border-radius:50%;border:3px solid var(--primary-color);object-fit:cover}
  input[type="text"],input[type="number"]{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit}
  .bottom-nav{position:fixed;bottom:0;left:0;right:0;max-width:500px;margin:0 auto;display:flex;justify-content:space-around;padding:10px 0;background:var(--surface-dark);border-top:1px solid rgba(255,255,255,0.03)}
  /* additional styles from original app (kept concise) */
  .chart { display:flex; justify-content:space-around; align-items:flex-end; height:150px; border-left:1px solid; border-bottom:1px solid; padding-top:10px; }
</style>
</head>
<body>
<div id="app-loader">
  <div class="spinner"></div>
  <div id="loading-progress">Loading... 0%</div>
</div>

<div id="banner-placeholder" class="banner" style="display:none"></div>

<div id="app" role="application" aria-label="TONHUB App" style="display:none;">

<!-- Begin: full original app UI (cleaned to avoid duplicate html/head/body tags) -->
<header class="profile-header">
    <img id="user-photo" src="https://via.placeholder.com/80" alt="User">
    <h1 id="user-name">Loading...</h1>
    <div id="user-balance-container">Balance: <span id="user-balance">0.00000</span> TON</div>
</header>

<main id="main-content">
    <div id="home-page" class="page active">
        <div class="promo-card task-container" style="background:#1A2432;">
          <div class="promo-header" style="display:flex;align-items:center;gap:8px;margin-bottom:10px">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64" width="26" height="26">
              <defs><linearGradient id="blueGiftGradient" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#00BFFF"/><stop offset="100%" stop-color="#1E90FF"/></linearGradient></defs>
              <rect x="6" y="14" width="52" height="10" rx="2" fill="url(#blueGiftGradient)"/>
              <rect x="10" y="24" width="44" height="28" rx="3" fill="url(#blueGiftGradient)"/>
              <rect x="30" y="14" width="4" height="38" fill="#ffffff" opacity="0.9"/>
              <rect x="10" y="32" width="44" height="4" fill="#ffffff" opacity="0.9"/>
              <path fill="url(#blueGiftGradient)" d="M32 14 c-2-5-8-7-12-4 c-3 2-3 6 0 8 c3 2 7 1 10-2 c3 3 7 4 10 2 c3-2 3-6 0-8 c-4-3-10-1-12 4z"/>
            </svg>
            <h3 style="color:#fff;margin:0">Promo Code</h3>
          </div>
          <div class="promo-body" style="display:flex;gap:8px;align-items:center">
            <input type="text" id="promoInput" placeholder="Enter Promo Code" style="flex:1;background:#111a25;border:1px solid rgba(255,255,255,0.05);padding:10px;border-radius:8px;color:#fff;">
            <button id="promoClaimBtn" class="action-btn">Claim</button>
          </div>
          <p id="promoMessage" style="margin-top:10px;color:#fff;display:none"></p>
        </div>

        <div class="stats-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:15px;margin:20px 0">
            <div class="stat-card task-container"><h3 style="font-size:0.85rem">TODAY ADS</h3><p id="daily-ads-watched">0 / 0</p></div>
            <div class="stat-card task-container"><h3 style="font-size:0.85rem">TOTAL ADS</h3><p id="total-ads-watched">0</p></div>
            <div class="stat-card task-container"><h3 style="font-size:0.85rem">Total Referrals</h3><p id="referral-count">0</p></div>
            <div class="stat-card task-container"><h3 style="font-size:0.85rem">Total Earnings</h3><p id="total-earned">0.00</p></div>
        </div>

        <div id="earnings-graph-container" class="chart-container task-container">
            <h3>Last 7 Days Earnings</h3>
            <div id="earnings-chart" class="chart"></div><div id="earnings-chart-labels" class="chart-labels"></div>
        </div>

        <div id="dynamic-links-container" class="task-container"></div>
    </div>

    <div id="tasks-page" class="page" style="display:none">
        <div class="earning-wallet-card task-container">
          <div id="referral-section"></div>
          <div style="display:none">
            <h3>Claim Earnings</h3>
            <p style="font-size:1.8rem;color:var(--primary-color)"><span id="earning-wallet-balance">0.00</span></p>
            <button id="move-to-balance-btn" class="action-btn" disabled>CLAIM</button>
          </div>
        </div>

        <div class="ads-t task-container" style="background:#0e1621;border-radius:14px;padding:14px">
          <h3 style="color:#fff;font-size:17px">Watch ADS</h3>
        </div>

        <div id="ad-progress-container" class="progress-container task-container" style="margin-top:20px"></div>
        <div id="ad-task-container" class="task-container"></div>

        <div class="partner-card task-container"><h3 style="color:#fff;font-size:17px">Partner Tasks</h3></div>
        <div id="dynamic-tasks-container" class="task-container"></div>
    </div>

    <div id="leaderboard-page" class="page" style="display:none">
        <h2>Leaderboard</h2>
        <div class="leaderboard-toggle" style="display:flex;justify-content:space-around;margin-bottom:15px">
            <button class="toggle-btn active" data-board="referral">TOP Leaders</button>
            <button class="toggle-btn" data-board="earning">TOP Users</button>
        </div>
        <div id="referral-board"><ul class="leaderboard-list" id="referral-leaderboard-list"></ul></div>
        <div id="earning-board" style="display:none"><ul class="leaderboard-list" id="earning-leaderboard-list"></ul></div>
    </div>

    <div id="profile-page" class="page" style="display:none">
        <div id="withdraw-section" class="task-container"></div>
        <div id="withdrawal-history-section" class="task-container">
            <div class="wid-his"><h3 style="color:#fff">Withdrawals History</h3></div>
            <div id="withdrawal-history-list"></div>
        </div>
    </div>
</main>

<nav class="bottom-nav" style="position:fixed;bottom:0;left:0;right:0;max-width:500px;margin:0 auto;display:flex;justify-content:space-around;padding:10px 0;background:var(--surface-dark);border-top:1px solid rgba(255,255,255,0.03);">
    <button class="nav-btn active" data-page="home-page"><i class="fa-solid fa-house-chimney"></i><span>Home</span></button>
    <button class="nav-btn" data-page="tasks-page"><i class="fa-solid fa-coins"></i><span>Earnings</span></button>
    <button class="nav-btn" data-page="leaderboard-page"><i class="fa-solid fa-trophy"></i><span>Leaderboard</span></button>
    <button class="nav-btn" data-page="profile-page"><i class="fa solid fa-wallet"></i><span>Withdraw</span></button>
</nav>

<!-- End original UI -->

</div>

<!-- libs -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<script>
/* Full app logic merged: uses your APP_KEY and DATABASE_BASE, initializes firebase once,
   verifies appKey and loads data, with banners and loader handling. */

const APP_KEY = "TGAPP_fW9AqB7v42KpD8Q0x7nC3Zt9";
const DATABASE_BASE = "https://tonhub-5fd59-default-rtdb.firebaseio.com";

const firebaseConfig = {
  apiKey: "AIzaSyB1meI_uZzhI-CYXgBf6Y2loCHyNeiUl2c",
  authDomain: "tonhub-5fd59.firebaseapp.com",
  databaseURL: "https://tonhub-5fd59-default-rtdb.firebaseio.com",
  projectId: "tonhub-5fd59",
  storageBucket: "tonhub-5fd59.firebasestorage.app",
  messagingSenderId: "196015492895",
  appId: "1:196015492895:web:8b43a1c0281c5f6d5b2a2a",
  measurementId: "G-2GMPVF5QKV"
};

function setProgress(n){ const el = document.getElementById('loading-progress'); if(el) el.textContent = 'Loading... ' + n + '%'; }
function showBanner(message, success=true){
  const wrap = document.getElementById('banner-placeholder');
  wrap.innerHTML = '';
  const inner = document.createElement('div');
  inner.className = 'banner-inner';
  inner.innerHTML = (success?('<svg width="22" height="22" viewBox="0 0 24 24" fill="#2ca67a"><path d="M9 16.17l-3.88-3.88a1 1 0 1 0-1.41 1.42l4.59 4.58a1 1 0 0 0 1.41 0l9.59-9.59a1 1 0 0 0-1.41-1.41L9 16.17z"/></svg>'):'<svg width="22" height="22" viewBox="0 0 24 24" fill="#e53935"><path d="M12 10.585l4.95-4.95 1.415 1.414L13.415 12l4.95 4.95-1.415 1.414L12 13.415l-4.95 4.95-1.415-1.414L10.585 12 5.635 7.05l1.415-1.414L12 10.585z"/></svg>') + '<span style="margin-left:8px">'+ String(message) +'</span>');
  wrap.appendChild(inner);
  wrap.style.display = 'flex';
  setTimeout(()=>{ wrap.style.display = 'none'; wrap.innerHTML=''; }, 3500);
}

async function verifyAppAccess(APP_KEY, DATABASE_BASE){
  setProgress(5);
  var base = DATABASE_BASE.replace(/\/+$/,'');
  var url = base + "/appData.json?orderBy=%22appKey%22&equalTo=%22" + encodeURIComponent(APP_KEY) + "%22";
  const resp = await fetch(url, {method:'GET', cache:'no-store'});
  setProgress(12);
  if(!resp.ok){ throw new Error('HTTP '+resp.status); }
  return resp.json();
}

async function start(){
  setProgress(1);
  try{
    if(window.Telegram && window.Telegram.WebApp && typeof window.Telegram.WebApp.ready === 'function'){
      try{ window.Telegram.WebApp.ready(); }catch(e){}
    }
    setProgress(3);
    const data = await verifyAppAccess(APP_KEY, DATABASE_BASE);
    const allowed = data && Object.keys(data).length > 0;
    if(!allowed){
      setProgress(100);
      showBanner("Access denied: appKey not found", false);
      document.getElementById('app-loader').style.display = 'none';
      return;
    }
    setProgress(20);
    if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    setProgress(30);
    await bootstrapApp();
  }catch(err){
    console.error('Verification error', err);
    showBanner('Verification failed: ' + (err.message || err), false);
    setProgress(100);
    document.getElementById('app-loader').style.display = 'none';
  }
}

async function bootstrapApp(){
  setProgress(45);
  const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
  try{
    const db = firebase.database();
    let tgUser = (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) ? tg.initDataUnsafe.user : { id: 'guest_'+Math.floor(Math.random()*100000), first_name: 'Guest' };
    const userRef = db.ref('users/' + tgUser.id);
    const snapshot = await userRef.once('value');
    let userData = snapshot.val();
    if(!userData){
      userData = { id: tgUser.id, firstName: tgUser.first_name || '', username: tgUser.username || '', balance: 0, referrals:0, totalEarned:0, dailyAdCount:0, lifetimeAdCount:0, completedTasks:{} };
      await userRef.set(userData);
    }
    setProgress(65);

    const cfgSnap = await db.ref('config').once('value');
    const appConfig = cfgSnap.val() || { dailyAdLimit:1, adValue:0.0005, adZoneId: null, welcomeMessage: '✅ قاعدة البيانات تعمل بشكل طبيعي' };
    document.getElementById('user-photo').src = userData.photoUrl || 'https://via.placeholder.com/80';
    document.getElementById('user-name').textContent = userData.firstName || 'User';
    document.getElementById('user-balance').textContent = (userData.balance || 0).toFixed(5);
    // wire promo
    document.getElementById('promoClaimBtn').addEventListener('click', async ()=>{
      const code = document.getElementById('promoInput').value.trim().toUpperCase();
      const promoMsg = document.getElementById('promoMessage');
      promoMsg.style.display = 'none';
      if(!code){ showBanner('Enter a promo code', false); return; }
      const promos = { 'TONHUB1':0.001, 'TONHUB2':0.0005, 'TONHUB3':0.0005 };
      if(!promos[code]){ showBanner('Invalid promo code', false); return; }
      const usedRef = db.ref(`usedPromoCodes/${tgUser.id}/${code}`);
      const snap = await usedRef.once('value');
      if(snap.exists()){ showBanner('Already Claimed', false); return; }
      await usedRef.set(true);
      await userRef.child('balance').set(firebase.database.ServerValue.increment(promos[code]));
      showBanner(`${promos[code]} TON Received!`, true);
      const updated = await userRef.once('value');
      document.getElementById('user-balance').textContent = ((updated.val()||{}).balance||0).toFixed(5);
    });

    // watch ad
    document.getElementById('watch-ad-btn').addEventListener('click', async ()=>{
      const adValue = appConfig.adValue || 0;
      await userRef.child('balance').set(firebase.database.ServerValue.increment(adValue));
      await userRef.child('dailyAdCount').set(firebase.database.ServerValue.increment(1));
      await userRef.child('lifetimeAdCount').set(firebase.database.ServerValue.increment(1));
      showBanner(`You earned ${adValue} TON`, true);
      const updated = await userRef.once('value');
      document.getElementById('user-balance').textContent = ((updated.val()||{}).balance||0).toFixed(5);
    });

    // navigation
    document.querySelectorAll('.nav-btn').forEach(btn=>{
      btn.addEventListener('click',()=>{
        document.querySelectorAll('.page').forEach(p=>p.style.display='none');
        document.getElementById(btn.dataset.page).style.display='block';
      });
    });

    setProgress(100);
    document.getElementById('app-loader').style.display = 'none';
    document.getElementById('app').style.display = 'block';
    if(appConfig.welcomeMessage) showBanner(appConfig.welcomeMessage, true);

  }catch(err){
    console.error('App bootstrap failed', err);
    showBanner('Initialization error: '+ (err.message||err), false);
    document.getElementById('app-loader').style.display = 'none';
  }
}

document.addEventListener('DOMContentLoaded', start);
</script>

</body>
</html>
