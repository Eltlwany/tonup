<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>TON HUB - Mini App</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{--font-family:'Poppins',sans-serif;--primary:#0088cc;--accent:#36aeea;--bg1:#07101a;--bg2:#0f1720;--text:#eaf2f8;--muted:#9fb1c2}
*{box-sizing:border-box;margin:0;padding:0}body{font-family:var(--font-family);background:linear-gradient(180deg,var(--bg1),var(--bg2));color:var(--text);-webkit-font-smoothing:antialiased}
#splash{position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:linear-gradient(180deg,var(--bg1),var(--bg2));z-index:9999;transition:opacity .6s}
.logo-wrap{width:200px;height:200px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:radial-gradient(circle,#06202a,rgba(0,0,0,0.2));box-shadow:0 8px 40px rgba(0,136,204,0.12)}
.logo-inner{width:74%;height:74%;border-radius:50%;display:flex;align-items:center;justify-content:center;background:radial-gradient(circle,#00182a,#002b3a)}
.logo-inner img{width:80%;height:80%;object-fit:contain;border-radius:12%}
#loading-text{margin-top:18px;color:var(--accent);font-weight:600;display:flex;gap:8px;align-items:center}
.app{max-width:520px;margin:0 auto;padding-bottom:90px;display:none;opacity:0;transition:opacity .4s}
.header{padding:18px;text-align:center}
.profile-avatar{width:88px;height:88px;border-radius:50%;overflow:hidden;margin:0 auto;border:3px solid rgba(0,136,204,0.14)}
.profile-name{margin-top:8px;font-weight:700}
.profile-balance{margin-top:8px;padding:8px 12px;border-radius:12px;background:linear-gradient(90deg,rgba(0,136,204,0.06),rgba(54,174,234,0.03));display:inline-block;color:var(--accent);font-weight:700}
.container{padding:14px}
.card{background:rgba(255,255,255,0.02);padding:12px;border-radius:12px;margin-bottom:12px;border:1px solid rgba(255,255,255,0.03)}
.controls{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-bottom:10px}
.btn{padding:10px 14px;border-radius:10px;background:linear-gradient(90deg,var(--primary),var(--accent));border:none;color:#fff;cursor:pointer;font-weight:600}
.input{width:100%;padding:10px;border-radius:10px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--text)}
.banner{position:fixed;top:18px;left:0;right:0;display:flex;justify-content:center;z-index:99999;pointer-events:none}
.banner .inner{pointer-events:auto;background:#0f1114;color:#fff;padding:10px 14px;border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,0.6)}
.progress{height:10px;background:rgba(255,255,255,0.03);border-radius:8px;overflow:hidden}
.progress > div{height:100%;width:0%;background:linear-gradient(90deg,var(--primary),var(--accent));transition:width .4s}
.footer{position:fixed;left:0;right:0;bottom:12px;display:flex;justify-content:center;padding:10px}
.small{color:var(--muted);font-size:0.9rem}
</style>
</head>
<body>
<div id="splash" aria-hidden="false">
  <div class="logo-wrap"><div class="logo-inner"><img id="splash-logo" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MTIiIGhlaWdodD0iNTEyIiB2aWV3Qm94PSIwIDAgNjQgNjQiPjxyZWN0IHdpZHRoPSI2NCIgaGVpZ2h0PSI2NCIgcng9IjgiIGZpbGw9IiMwMDE4MmEiLz48ZyBmaWxsPSIjMDBjNmZmIj48cGF0aCBkPSJNOSA2IEw1NSA2IEwzMiA1NCBaIi8+PC9nPjwvc3ZnPg==" alt="logo"></div></div>
  <div id="loading-text">Loading <span class="dot">...</span></div>
</div>

<div id="banner" class="banner" style="display:none"><div class="inner" id="banner-text"></div></div>

<div class="app" id="app">
  <div class="header">
    <div class="profile-avatar"><img id="user-photo" src="https://via.placeholder.com/150" alt="user"></div>
    <div class="profile-name" id="user-name">Guest</div>
    <div class="profile-balance" id="user-balance">0.00000 TON</div>
  </div>
  <div class="container">
    <div class="card">
      <h3>Promo Code</h3>
      <div style="display:flex;gap:8px">
        <input id="promoInput" class="input" placeholder="Enter promo code">
        <button id="promo-btn" class="btn">Claim</button>
      </div>
    </div>

    <div class="card" id="stats-area">
      <div style="display:flex;flex-direction:column;gap:10px">
        <div class="card"><small class="small">TOTAL ADS</small><div id="total-ads" style="font-weight:700;color:var(--accent)">0</div></div>
        <div class="card"><small class="small">TODAY ADS</small><div id="today-ads" style="font-weight:700;color:var(--accent)">0 / 5</div></div>
      </div>
    </div>

    <div class="card">
      <h4>Ads Progress</h4>
      <div class="progress"><div id="ads-progress"></div></div>
      <div style="display:flex;justify-content:space-between;margin-top:8px"><span id="ads-progress-text">0 / 5</span><span id="ads-progress-percent">0%</span></div>
    </div>

    <div class="card" id="watch-card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><small class="small">Watch Ads</small><div style="font-weight:700;color:var(--accent)">Earn TON</div></div>
        <button id="watch-btn" class="btn">Watch</button>
      </div>
    </div>

    <div class="card" id="tasks-list"><h4>Earn Tasks</h4><div id="tasks-container"><small class="small">Loading tasks...</small></div></div>

    <div class="card" id="withdraw-card">
      <h4>Withdraw</h4>
      <input id="withdraw-amount" class="input" placeholder="Amount">
      <input id="withdraw-method" class="input" placeholder="Method (e.g. TON Wallet)">
      <input id="withdraw-account" class="input" placeholder="Account / Address">
      <button id="withdraw-btn" class="btn">Request Withdraw</button>
    </div>

  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script>
const APP_KEY = "TGAPP_fW9AqB7v42KpD8Q0x7nC3Zt9";
const SPLASH_MS = 5000;
function showBanner(msg, type='info', t=3000){
  const b = document.getElementById('banner'); const txt = document.getElementById('banner-text');
  txt.textContent = msg; b.style.display='flex';
  if(t) setTimeout(()=>{ b.style.display='none'; }, t);
}

const firebaseConfig = {
  apiKey: "AIzaSyB1meI_uZzhI-CYXgBf6Y2loCHyNeiUl2c",
  authDomain: "tonhub-5fd59.firebaseapp.com",
  databaseURL: "https://tonhub-5fd59-default-rtdb.firebaseio.com",
  projectId: "tonhub-5fd59",
  storageBucket: "tonhub-5fd59.firebasestorage.app",
  messagingSenderId: "196015492895",
  appId: "1:196015492895:web:8b43a1c0281c5f6d5b2a2a",
  measurementId: "G-2GMPVF5QKV"
};

let db, user = null;
function uid(){ return 'u'+Math.floor(Math.random()*1e9) }

document.addEventListener('DOMContentLoaded', async ()=>{
  // splash hide after SPLASH_MS
  setTimeout(()=>{ document.getElementById('splash').style.opacity=0; setTimeout(()=>{ document.getElementById('splash').style.display='none'; document.getElementById('app').style.display='block'; setTimeout(()=>document.getElementById('app').style.opacity=1,40); },600); }, SPLASH_MS);

  try{
    firebase.initializeApp(firebaseConfig);
    db = firebase.database();
    const snap = await db.ref('appKey').once('value'); const remote = snap.val();
    if(remote && remote===APP_KEY){ showBanner('✅ Database OK','success',2500); } else { showBanner('🔒 Security rules block access','error',4000); }
  }catch(e){ console.error(e); showBanner('⚠️ Failed to connect to Firebase','error',4000); }

  // simple user identification (Telegram WebApp integration optional)
  try{
    const tgUser = window.Telegram?.WebApp?.initDataUnsafe?.user;
    if(tgUser){ user = { id: tgUser.id, username: tgUser.username || tgUser.first_name, photo: tgUser.photo_url }; }
  }catch(e){}
  if(!user){ user = { id: uid(), username: 'guest_'+Math.floor(Math.random()*9000), photo: null }; }

  // set profile
  if(user.photo) document.getElementById('user-photo').src = user.photo;
  document.getElementById('user-name').textContent = user.username;
  // ensure user record exists
  await db.ref('users/'+user.id).once('value').then(s=>{ if(!s.exists()){ db.ref('users/'+user.id).set({ id:user.id, username:user.username, balance:0, referrals:0 }); }});
  // load user balance
  const b = await db.ref('users/'+user.id+'/balance').once('value'); document.getElementById('user-balance').textContent = Number(b.val()||0).toFixed(5)+' TON';

  // load config
  const cfgSnap = await db.ref('config').once('value'); const cfg = cfgSnap.val() || {};
  const AD_VALUE = cfg.adValue || 0.0005;
  const DAILY_LIMIT = cfg.dailyAdLimit || 5;
  const TASKS = cfg.tasks || {};
  const REF_BONUS = cfg.referralBonus || 0;

  // render tasks
  const tasksContainer = document.getElementById('tasks-container'); tasksContainer.innerHTML='';
  Object.keys(TASKS).forEach(k=>{
    const t = TASKS[k];
    const div = document.createElement('div'); div.className='card';
    div.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><strong>${t.name}</strong><div class="small">${t.reward} TON</div></div><div><button class="btn" data-task="${k}">Complete</button></div></div>`;
    tasksContainer.appendChild(div);
  });

  // promo
  document.getElementById('promo-btn').addEventListener('click', async ()=>{
    const code = document.getElementById('promoInput').value.trim().toUpperCase();
    if(!code){ showBanner('Please enter promo code','error'); return; }
    const pSnap = await db.ref('promoCodes/'+code).once('value');
    if(!pSnap.exists()){ showBanner('Invalid promo code','error'); return; }
    const amt = pSnap.val();
    // check used
    const used = await db.ref('usedPromoCodes/'+user.id+'/'+code).once('value');
    if(used.exists()){ showBanner('Already claimed','error'); return; }
    // add balance and mark used
    await db.ref('users/'+user.id+'/balance').set(firebase.database.ServerValue.increment(amt));
    await db.ref('usedPromoCodes/'+user.id+'/'+code).set(true);
    showBanner('✅ Promo applied','success',2500);
    // refresh balance
    const nb = await db.ref('users/'+user.id+'/balance').once('value'); document.getElementById('user-balance').textContent = Number(nb.val()||0).toFixed(5)+' TON';
  });

  // watch ad
  let adsWatched = 0;
  document.getElementById('watch-btn').addEventListener('click', async ()=>{
    if(adsWatched >= DAILY_LIMIT){ showBanner('Daily ad limit reached','info'); return; }
    adsWatched++;
    // reward
    await db.ref('users/'+user.id+'/balance').set(firebase.database.ServerValue.increment(AD_VALUE));
    // increment totals
    const totalSnap = await db.ref('stats/totalAds').once('value'); const total = (totalSnap.val()||0)+1; await db.ref('stats/totalAds').set(total);
    // update UI
    const nb = await db.ref('users/'+user.id+'/balance').once('value'); document.getElementById('user-balance').textContent = Number(nb.val()||0).toFixed(5)+' TON';
    document.getElementById('total-ads').textContent = total;
    document.getElementById('today-ads').textContent = adsWatched+' / '+DAILY_LIMIT;
    const pct = Math.round((adsWatched/DAILY_LIMIT)*100); document.getElementById('ads-progress').style.width = pct + '%';
    document.getElementById('ads-progress-text').textContent = adsWatched+' / '+DAILY_LIMIT;
    document.getElementById('ads-progress-percent')?.textContent = pct + '%';
    showBanner('✅ You earned '+AD_VALUE+' TON','success',2200);
  });

  // task complete handler
  document.addEventListener('click', async (e)=>{
    if(e.target && e.target.dataset && e.target.dataset.task){
      const key = e.target.dataset.task;
      const t = TASKS[key];
      if(!t){ showBanner('Task not found','error'); return; }
      // reward user
      await db.ref('users/'+user.id+'/balance').set(firebase.database.ServerValue.increment(t.reward));
      // update UI balance
      const nb = await db.ref('users/'+user.id+'/balance').once('value'); document.getElementById('user-balance').textContent = Number(nb.val()||0).toFixed(5)+' TON';
      showBanner('✅ Task completed, reward added','success',2200);
    }
  });

  // withdraw request
  document.getElementById('withdraw-btn').addEventListener('click', async ()=>{
    const amt = parseFloat(document.getElementById('withdraw-amount').value);
    const method = document.getElementById('withdraw-method').value.trim();
    const account = document.getElementById('withdraw-account').value.trim();
    if(!amt || !method || !account){ showBanner('Please fill withdraw details','error'); return; }
    // check user balance
    const bSnap = await db.ref('users/'+user.id+'/balance').once('value'); const bal = Number(bSnap.val()||0);
    if(amt > bal){ showBanner('Insufficient balance','error'); return; }
    // check min withdraw - get config withdrawMethods[0].min if present
    const cfg = (await db.ref('config').once('value')).val()||{};
    const methods = cfg.withdrawMethods || [];
    const min = (methods[0] && methods[0].min) ? methods[0].min : 0;
    if(amt < min){ showBanner('Amount below minimum withdraw','error'); return; }
    // deduct balance immediately
    await db.ref('users/'+user.id+'/balance').set(firebase.database.ServerValue.increment(-amt));
    const reqId = 'r'+Date.now()+Math.floor(Math.random()*1000);
    const payload = { id:reqId, userId:user.id, userName:user.username, amount:amt, method, account, timestamp:Date.now() };
    await db.ref('withdrawals/pending/'+reqId).set(payload);
    showBanner('✅ Withdraw request submitted','success',3000);
    // refresh balance
    const nb = await db.ref('users/'+user.id+'/balance').once('value'); document.getElementById('user-balance').textContent = Number(nb.val()||0).toFixed(5)+' TON';
  });

  // load stats
  const totalSnap2 = await db.ref('stats/totalAds').once('value'); document.getElementById('total-ads').textContent = totalSnap2.val()||0;

}); // DOMContentLoaded
</script>
</body>
</html>
.page{padding:14px;display:none}.page.active{display:block;animation:fadeIn .45s ease}
.card{background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));border-radius:14px;padding:14px;border:1px solid rgba(255,255,255,0.03);margin-bottom:12px}

/* banner */
.app-banner{position:fixed;left:0;right:0;top:18px;display:flex;justify-content:center;z-index:999999;pointer-events:none}
.app-banner .inner{pointer-events:auto;display:flex;align-items:center;gap:12px;padding:12px 16px;border-radius:14px;color:#fff;background:#0f1114;box-shadow:0 8px 30px rgba(0,0,0,0.6)}
.app-banner.success .inner{box-shadow:0 8px 30px rgba(0,0,0,0.5),0 0 18px rgba(44,166,122,0.18)}
.app-banner.error .inner{box-shadow:0 8px 30px rgba(0,0,0,0.5),0 0 18px rgba(229,57,53,0.18)}
.app-banner.info .inner{box-shadow:0 8px 30px rgba(0,0,0,0.5),0 0 18px rgba(0,136,204,0.12)}

/* bottom nav */
.bottom-nav{position:fixed;left:0;right:0;bottom:12px;display:flex;gap:12px;justify-content:space-around;padding:10px;max-width:520px;margin:0 auto;z-index:900}
.bottom-btn{flex:1;padding:10px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);border:1px solid rgba(255,255,255,0.03);display:flex;flex-direction:column;align-items:center;gap:6px;cursor:pointer;color:var(--muted);font-weight:600}
.bottom-btn.active{background:linear-gradient(90deg,var(--primary),var(--accent));color:#fff;box-shadow:0 8px 30px rgba(0,136,204,0.12)}
@media(max-width:420px){.logo-wrap{width:160px;height:160px}.profile-avatar{width:84px;height:84px}}
</style>
</head>
<body>
<!-- SPLASH -->
<div id="splash" aria-hidden="false">
  <div class="logo-wrap" role="img" aria-label="app logo">
    <div class="glow"></div>
    <div class="logo-inner">
      <img id="splash-logo" src=data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MTIiIGhlaWdodD0iNTEyIiB2aWV3Qm94PSIwIDAgNjQgNjQiPgogIDxyZWN0IHdpZHRoPSI2NCIgaGVpZ2h0PSI2NCIgcng9IjgiIGZpbGw9IiMwMDE4MmEiLz4KICA8ZyBmaWxsPSIjMDBjNmZmIj4KICAgIDxwYXRoIGQ9Ik05IDYgTDU1IDYgTDMyIDU0IFoiLz4KICA8L2c+Cjwvc3ZnPg==" alt="App Logo">
    </div>
  </div>
  <div id="loading-text"><span>Loading</span>
    <span class="dot d1"></span><span class="dot d2"></span><span class="dot d3"></span>
  </div>
</div>

<!-- BANNER -->
<div id="banner-container" class="app-banner" aria-live="polite" style="display:none"></div>

<!-- APP -->
<div id="app" aria-hidden="true">
  <header class="profile-header">
    <div class="profile-avatar"><img id="user-photo" src="https://via.placeholder.com/150" alt="user"></div>
    <div class="profile-name" id="user-name">----</div>
    <div class="profile-balance" id="user-balance">0.00000 TON</div>
  </header>

  <main style="padding:14px">
    <section class="controls" id="controls">
      <button class="control-btn" data-page="home-page"><i class="fa-solid fa-house-chimney"></i>Home</button>
      <button class="control-btn" data-page="tasks-page"><i class="fa-solid fa-coins"></i>Earnings</button>
      <button class="control-btn" data-page="leaderboard-page"><i class="fa-solid fa-trophy"></i>Leaderboard</button>
      <button class="control-btn" data-page="profile-page"><i class="fa-solid fa-wallet"></i>Withdraw</button>
    </section>

    <section id="home-page" class="page active">
      <div class="card">
        <h3 style="margin-bottom:8px">Promo Code</h3>
        <div style="display:flex;gap:8px;align-items:center">
          <input id="promoInput" placeholder="Enter Promo Code" style="flex:1;padding:10px;border-radius:10px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--text)"/>
          <button id="promo-btn" class="control-btn" style="min-width:96px">Claim</button>
        </div>
        <p id="promoMessage" style="margin-top:10px;color:var(--muted);display:none"></p>
      </div>

      <div class="card" id="stats-card">
        <div style="display:flex;justify-content:space-between;gap:12px">
          <div><small style="color:var(--muted)">TODAY ADS</small><div id="daily-ads-watched" style="font-weight:700;color:var(--primary)">0 / 0</div></div>
          <div><small style="color:var(--muted)">TOTAL ADS</small><div id="total-ads-watched" style="font-weight:700;color:var(--primary)">0</div></div>
          <div><small style="color:var(--muted)">REFERRALS</small><div id="referral-count" style="font-weight:700;color:var(--primary)">0</div></div>
        </div>
      </div>
    </section>

    <section id="tasks-page" class="page">
      <div class="card">
        <h3>Watch ADS</h3>
        <div id="ad-task-container"></div>
      </div>
    </section>

    <section id="leaderboard-page" class="page">
      <div class="card"><h3>Leaderboard</h3><ul id="leaderboard-list" style="margin-top:10px"></ul></div>
    </section>

    <section id="profile-page" class="page">
      <div class="card">
        <h3>Withdraw</h3>
        <div id="withdraw-section"></div>
      </div>
    </section>
  </main>
</div>

<nav class="bottom-nav">
  <div class="bottom-btn active" data-page="home-page"><i class="fa-solid fa-house-chimney"></i><small>Home</small></div>
  <div class="bottom-btn" data-page="tasks-page"><i class="fa-solid fa-coins"></i><small>Earn</small></div>
  <div class="bottom-btn" data-page="leaderboard-page"><i class="fa-solid fa-trophy"></i><small>Top</small></div>
  <div class="bottom-btn" data-page="profile-page"><i class="fa-solid fa-user"></i><small>Profile</small></div>
</nav>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script>
const APP_KEY = "TGAPP_fW9AqB7v42KpD8Q0x7nC3Zt9";
const SPLASH_DURATION = 5000;

function showBanner(message, type="info", autoHide=3500){
  const container = document.getElementById("banner-container");
  container.innerHTML = "";
  const wrapper = document.createElement("div");
  wrapper.className = "inner";
  const icon = document.createElement("span");
  icon.innerHTML = (type==="success")?'<svg viewBox="0 0 24 24" fill="#2ca67a" xmlns="http://www.w3.org/2000/svg"><path d="M9 16.17 4.12 11.29l-1.41 1.41L9 19 21.29 6.71 19.88 5.29z"/></svg>':(type==="error")?'<svg viewBox="0 0 24 24" fill="#e53935" xmlns="http://www.w3.org/2000/svg"><path d="M18.3 5.71 12 12l6.3 6.29L19.71 20.3 13.41 14 7.12 20.29 5.71 18.88 12 12 5.71 5.71 7.12 4.3 13.41 10.59 19.71 4.29z"/></svg>':'<svg viewBox="0 0 24 24" fill="#00a6ff" xmlns="http://www.w3.org/2000/svg"><path d="M11 7h2v6h-2zM11 15h2v2h-2z"/></svg>';
  wrapper.appendChild(icon);
  const text = document.createElement("div"); text.style.marginLeft="8px"; text.textContent = message;
  wrapper.appendChild(text); container.appendChild(wrapper);
  container.style.display = "flex"; container.className = `app-banner ${type}`;
  if(autoHide) setTimeout(()=>{container.style.display="none"}, autoHide);
}

function qs(s){return document.querySelector(s)}
function qsa(s){return Array.from(document.querySelectorAll(s))}

document.addEventListener("DOMContentLoaded", async ()=>{
  const tg = window.Telegram?.WebApp;
  try{ if(tg && typeof tg.ready==="function") tg.ready(); }catch(e){}
  const splash = qs("#splash"), appEl = qs("#app");
  // Fade out after SPLASH_DURATION
  setTimeout(()=>{ splash.style.opacity=0; setTimeout(()=>{ splash.style.display="none"; appEl.style.display="block"; setTimeout(()=>appEl.style.opacity=1,40); },600); }, SPLASH_DURATION);

  // Initialize Firebase and check appKey
  const firebaseConfig = {
    "apiKey": "AIzaSyAFBsqYvPsQAPrnWvBfIIn0xKbQD8eFfFY",
    "authDomain": "ton-up-422b5.firebaseapp.com",
    "projectId": "ton-up-422b5",
    "storageBucket": "ton-up-422b5.firebasestorage.app",
    "messagingSenderId": "1097862104173",
    "appId": "1:1097862104173:web:752c30106f7e9fc553ab64",
    "measurementId": "G-R5YGH5QY0W"
  };
  try{
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const snap = await db.ref("appKey").once("value");
    const remote = snap.val();
    if(remote && remote===APP_KEY) showBanner("✅ قاعدة البيانات تعمل بشكل طبيعي","success",3000);
    else showBanner("🔒 القواعد الأمنية تمنع الوصول (محمي بالكامل)","error",5000);
  }catch(err){
    console.error("Firebase init failed",err);
    showBanner("⚠️ فشل الاتصال بقاعدة البيانات","error",4000);
  }

  // Telegram user -> profile
  try{
    const tgUser = window.Telegram?.WebApp?.initDataUnsafe?.user || null;
    if(tgUser){
      qs("#user-photo").src = tgUser.photo_url || "https://via.placeholder.com/150";
      qs("#user-name").textContent = tgUser.username ? ("@" + tgUser.username) : (tgUser.first_name || "User");
      // Optionally set splash logo to tg photo if available (keeps your embedded logo otherwise)
      if(tgUser.photo_url){
        const splashLogo = qs("#splash-logo");
        if(splashLogo) splashLogo.src = tgUser.photo_url;
      }
    }
  }catch(e){console.warn(e)}

  // Navigation
  function showPage(id){
    qsa(".page").forEach(p=>p.classList.remove("active"));
    const el = qs("#"+id); if(el) el.classList.add("active");
    qsa(".bottom-btn").forEach(b=>b.classList.remove("active"));
    qsa(".control-btn").forEach(b=>b.classList.remove("active"));
    qsa(`.bottom-btn[data-page='${id}']`).forEach(b=>b.classList.add("active"));
    qsa(`.control-btn[data-page='${id}']`).forEach(b=>b.classList.add("active"));
  }
  qsa(".control-btn").forEach(btn=>btn.addEventListener("click", ()=>showPage(btn.dataset.page)));
  qsa(".bottom-btn").forEach(btn=>btn.addEventListener("click", ()=>showPage(btn.dataset.page)));

  // Promo
  const promoCodes = { "TONHUB1":0.001,"TONHUB2":0.0005,"TONHUB3":0.0005 };
  qs("#promo-btn").addEventListener("click", async ()=>{
    const code = qs("#promoInput").value.trim().toUpperCase();
    if(!code){ showBanner("Please enter a promo code","error"); return; }
    if(!promoCodes[code]){ showBanner("Invalid promo code","error"); return; }
    try{
      const tgUser = window.Telegram?.WebApp?.initDataUnsafe?.user;
      const db = firebase.database();
      const usedRef = db.ref(`usedPromoCodes/${tgUser.id}/${code}`);
      const snapshot = await usedRef.once("value");
      if(snapshot.exists()){ showBanner("Already Claimed","error"); return; }
      await db.ref(`users/${tgUser.id}/balance`).set(firebase.database.ServerValue.increment(promoCodes[code]));
      await usedRef.set(true);
      showBanner(`${promoCodes[code]} TON Received!`,"success");
    }catch(e){console.error(e); showBanner(" Error applying promo. Please try again.","error") }
  });

  // simple ad task placeholder
  function renderAdTask(){
    const container = qs("#ad-task-container");
    container.innerHTML = `<div style="display:flex;gap:12px;align-items:center"><div style="flex:1"><small style="color:var(--muted)">Reward</small><div style="font-weight:700;color:var(--primary)">0.00000 TON</div></div><button class="control-btn" id="watch-ad">Watch AD</button></div>`;
    qs("#watch-ad")?.addEventListener("click", ()=>showBanner("AD network not configured","info"));
  }
  renderAdTask();

  qs("#leaderboard-list").innerHTML = `<li style="list-style:none;color:var(--muted)">No data available</li>`;
  qs("#withdraw-section").innerHTML = `<div style="display:flex;flex-direction:column;gap:8px"><input placeholder="Wallet address" style="padding:10px;border-radius:10px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--text)"><input placeholder="Amount" type="number" step="any" style="padding:10px;border-radius:10px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--text)"><button class="control-btn">Submit Request</button></div>`;
});
</script>
</body>
</html>
